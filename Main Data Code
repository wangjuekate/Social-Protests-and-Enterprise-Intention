#use Data


use "F:\All_Projects\Project_Lori_SocialMovementImpact\3_FinalDataset\CountyPanel20142016\Panel20142016.dta", clear

#Add DV

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Firm Application_2014_2016\Application.dta"



drop  _merge

#Add IV

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\Moderatesur2016.dta"

drop  _merge

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\RadicalSurveillance2016.dta"

drop  _merge

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\Shooting2016.dta"

drop  _merge

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\ProtestSurveillance2016.dta"

drop  _merge

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\Radicalmili2016.dta"

drop  _merge

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\Moderatemili2016.dta"

drop  _merge

gen percapita= taxgrossincome/TotalPop

egen newid = group( year month)

egen statecountycluster = group ( statefips countyfips)


merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Accidents\Accidents2016.dta"
drop  _merge


merge m:1 statefips countyfips using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\PTSD_PostWar Centers\postwar.dta"
drop  _merge


merge m:1 statefips countyfips using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Gun restrictions\Gunrestrictions.dta"
drop  _merge




#De Novo Firm
#Radical 

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Firm Application_2014_2016\OtherAdoption.dta"
drop  _merge


merge m:1 statefips countyfips using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\County Economic Environment\CountyYearEcon.dta"
drop  _merge


gen Ndenovo = Napplication- NUniveristy -publicadoption-NDealio
replace Ndenovo =0 if Ndenovo <0

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Regulations\Stateregulation2016.dta"
drop  _merge


merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Regulations\CombineDroneRegulation.dta"
drop  _merge


#Add hobbyists
merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Hobbyist\Hobbyistmerge.dta"
drop  _merge

#Add Pilots
merge m:1 statefips countyfips using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\PilotsDrone\pilots.dta"
drop  _merge


#Add clients
merge m:1 statefips countyfips year using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Clients\clients.dta"
drop  _merge


#Add Manufactures
merge m:1 statefips countyfips using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Manufacture\dronemanufacture.dta"
drop  _merge






drop residualwar
regress   radicalmili_2m postwartreatment  cumuapply   NUniveristy i.statefips i.newid

predict residualwar ,residual

drop residual

regress   radicalsur_2m  accidents_1m Totalpop  NUniveristy i.statefips i.newid

predict residual ,residual

xtset  newid statecountycluster


gen gdp  = irs130208d/1000000
gen Totalpop = totalpop /1000000

sum NDealio Ndenovo military   radicalsur_2m  pubprotest_2m  Allprivacy Allsecurity cumuapply  accidents_2m  unemploymentrate gdp Totalpop 

cor NDealio Ndenovo   military   radicalsur_2m  pubprotest_2m  Allprivacy Allsecurity cumuapply  accidents_2m  unemploymentrate gdp Totalpop 


esttab model1 model2 model3 model4 model5 model6 using ier.rtf, se sca(ll) star(* 0.05 ** 0.01 *** 0.001) replace

#merge weatherIV
merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\AttachRain Temperature_IV\rainfallCounty.dta"
drop  _merge


merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\AttachRain Temperature_IV\temperatureCounty.dta"
drop  _merge


# Construct the IV

regress  radicalsur_2m  temperature i.(year) i.statefips
predict temperatureIV
regress   moderatesur_2m  temperature i.(year) i.statefips
predict temperatureIVmoderatesur
regress   radicalmili_2m  temperature i.(year) i.statefips
predict temperatureIVradicalmili

regress   institutionsur_2m  temperature i.(year) i.statefips
predict temperatureIVinstitutional


#Add the diversity

merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\Combine_protestdiversity_lag.dta"
drop  _merge


# nonCalifornia surveillance negative
non California military positive

#California surveillance positive
military negative

#Add institutions
merge 1:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Drone Related Protests\Institutionalsur2016.dta"
drop  _merge


merge m:1 statefips countyfips year month using "F:\All_Projects\Project_Lori_SocialMovementImpact\2_VariableList\Surveillance Lawsuits_2006_2013\surveillancesuit.dta"
drop  _merge



esttab model1 model2 model3 model4 model5 model6 model7 model8 using ier.rtf, se sca(ll) star(* 0.05 ** 0.01 *** 0.001) replace

sum totalApplication  Ndenovo  NDealio   radicalmili_2m   radicalsur_2m  moderatesur_2m   institutionsur_2m diversity_2m  temperature dronemanufacture droneclient  privacy  california    NUniveristy  Nhobbyist  cumuapply  security accidents_1m  gdppercap Totalpop  totalpilots   publicadoption

cor totalApplication  Ndenovo  NDealio   radicalmili_2m   radicalsur_2m  moderatesur_2m   institutionsur_2m diversity_2m  temperature dronemanufacture droneclient  privacy  california    NUniveristy  Nhobbyist  cumuapply  security accidents_1m  gdppercap Totalpop  totalpilots   publicadoption

gen gdppercap = gdp/Totalpop


***********************************************************
Main Model
1) too many zeros: zero inflated
2) count variable: poisson model 
3) interdependence between de alio and de novo firms, joint probit and joint poisson
4) independence among the treatments (using IV to deal with it)

***********************************************************

gen totalApplication =  NDealio+ Ndenovo

zinb Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model1


zinb Ndenovo  temperatureIVradicalmili    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model2


zinb Ndenovo   temperatureIV    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model3


zinb Ndenovo   temperatureIVmoderatesur dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model4


zinb Ndenovo  temperatureIVinstitutional    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model5

zinb Ndenovo   temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional  c.( temperatureIV)#c.(temperatureIVmoderatesur)   dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model6

zinb Ndenovo   temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional  c.( temperatureIV)#c.(temperatureIVinstitutional ) temperaturecat rainfallcut  Number_of_Lawsuits   AntigunMov  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model7

zinb totalApplication   temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional  c.( temperatureIVmoderatesur)#c.(temperatureIVinstitutional ) temperaturecat rainfallcut  Number_of_Lawsuits   AntigunMov  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model8

zinb totalApplication   temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional  c.( temperatureIVmoderatesur)#c.(temperatureIVinstitutional ) temperaturecat rainfallcut  Number_of_Lawsuits   AntigunMov  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model9

zinb totalApplication     diversityIV dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model10




zinb  NDealio temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIVmoderatesur )#c.(temperatureIVinstitutional)   dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots Ndenovo  , inflate(  Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust


***********************************************************
Main Model with de novo and de alio separately estimated
***********************************************************


zinb Ndenovo   NDealio  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model3

zinb  NDealio Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model4


zinb Ndenovo temperatureIVradicalmili    NDealio  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model5

zinb  NDealio temperatureIVradicalmili  Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model6


zinb Ndenovo temperatureIV   NDealio  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  NDealio dronemanufacture droneclient privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model7

zinb  NDealio temperatureIV  Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model8


zinb Ndenovo temperatureIVmoderatesur   NDealio  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model9

zinb  NDealio temperatureIVmoderatesur  Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model10

zinb Ndenovo temperatureIVinstitutional  NDealio  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model11

zinb  NDealio temperatureIVinstitutional  Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust


est sto model12



zinb Ndenovo temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIV)#c.(temperatureIVmoderatesur)     dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots NDealio  , inflate(  NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model3

zinb  NDealio temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIV)#c.(temperatureIVmoderatesur)     dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots Ndenovo , inflate(  Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust


est sto model4


zinb Ndenovo temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIV )#c.(temperatureIVinstitutional)    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots   NDealio, inflate(  NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model5

zinb  NDealio temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIV )#c.(temperatureIVinstitutional)    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots Ndenovo , inflate( Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust


est sto model6


zinb Ndenovo temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIVmoderatesur )#c.(temperatureIVinstitutional)     dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots NDealio , inflate(NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model7

zinb  NDealio temperatureIV  temperatureIVmoderatesur temperatureIVinstitutional c.(temperatureIVmoderatesur )#c.(temperatureIVinstitutional)   dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots Ndenovo  , inflate(  Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust


est sto model8




esttab model3  model7  using ier.rtf, se sca(ll) star(* 0.05 ** 0.01 *** 0.001) replace

# Diversity drop the places without diversity


drop diversityIV
replace diversity_4m =1- diversity_4m
replace diversity_4m=. if diversity_4m ==0


regress diversity_4m temperature i.(year) i.statefips
predict diversityIV


zinb Ndenovo  diversityIV NDealio  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( NDealio dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust iter(20)

est sto model1

zinb  NDealio   diversityIV Ndenovo  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate( Ndenovo dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust iter(20)

est sto model2


***********************************************************
Transform into linear forms

***********************************************************
gen logdealio = log(NDealio) if  NDealio !=0

gen logdenovo = log(Ndenovo) if  Ndenovo !=0

cmp( dnovo = dronemanufacture droneclient   gdppercap  Totalpop  totalpilots)( daliotest =dronemanufacture droneclient    gdppercap  Totalpop  totalpilots)( logdealio  = temperatureIVinstitutional temperatureIV temperatureIVradicalmili temperatureIVmoderatesur dronemanufacture droneclient   gdppercap  Totalpop  totalpilots)( logdenovo = temperatureIVinstitutional temperatureIV temperatureIVradicalmili temperatureIVmoderatesur dronemanufacture droneclient    gdppercap  Totalpop  totalpilots), indicators($cmp_probit  $cmp_probit $cmp_cont  $cmp_cont ) quietly  robust


cmp( logdealio  = temperatureIVinstitutional temperatureIV temperatureIVradicalmili temperatureIVmoderatesur dronemanufacture droneclient   gdppercap  Totalpop  totalpilots)( logdenovo = temperatureIVinstitutional temperatureIV temperatureIVradicalmili temperatureIVmoderatesur dronemanufacture droneclient    gdppercap  Totalpop  totalpilots), indicators($cmp_cont  $cmp_cont ) quietly  robust

est sto model1


***********************************************************
Differences in Differences
1) random assign: probit model by day, interdependence among different events
2) treatment and control match: inverse probability weighting by county treatment day, inverse probability matching
3) multiple treatment: isolated, short term of time only one event happened. (select optimal time interval) Markov assumption, the impact does not last beyond the period. 

***********************************************************

cmp( moderatesur_2m = dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots)(radicalsur_2m=dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots)(radicalmili_2m= dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots)( institutionsur_2m= dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots), indicators($cmp_probit  $cmp_probit $cmp_probit $cmp_probit) quietly robust


cmp( moderatesur_2m = dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots)(radicalsur_2m=dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots)( institutionsur_2m= dronemanufacture droneclient  cityprivacy  california  publicadoption Nhobbyist  cumuapply accidents_2m  gdppercap  Totalpop  totalpilots), indicators($cmp_probit  $cmp_probit $cmp_probit) quietly robust




***********************************************************
Extreme case study: Synthetic Control
1) choose Los Angeles
2) Slice and match Los Angeles
***********************************************************

drop temperaturecat
egen  temperaturecat = cut( temperature), at(-100, -20,10,20,30,40, 50,100,150)
replace temperaturecat=0 if mi(temperaturecat)
replace temperaturecat= temperaturecat+100


drop rainfallcut
egen  rainfallcut= cut( rainfall), at(10,100,500,1000,2000,3000, 5000)
replace  rainfallcut=0 if mi( rainfallcut)

#test different Instrumental variables

regress  radicalmili_2m i.( temperaturecat)   i.(rainfallcut)    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots i.statefips i.newid

est sto model1
drop temperatureIVradicalmili
predict temperatureIVradicalmili

regress  radicalsur_2m i.( temperaturecat)   i.(rainfallcut)   gunrestrict  AntigunMov  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots i.statefips i.newid

est sto model2
drop temperatureIV
predict temperatureIV

regress   moderatesur_2m i.( temperaturecat) i.(rainfallcut)   gunrestrict  AntigunMov  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots i.statefips i.newid

est sto model3
drop  temperatureIVmoderatesur
predict  temperatureIVmoderatesur

regress   institutionsur_2m i.( temperaturecat)   i.(rainfallcut)   gunrestrict  AntigunMov  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots i.statefips i.newid

est sto model4
drop  temperatureIVinstitutional
predict  temperatureIVinstitutional

temperaturecat rainfallcut gunrestrict  AntigunMov

esttab model1 model2 model3  model4  using ier.rtf,   se  ar2 scalars(F ll ) star(* 0.05 ** 0.01 *** 0.001) replace


i.statefips   i.newid

********************************************************************
reduced form regression
*******************************************************************
temperaturecat   rainfallcut  gunrestrict  AntigunMov   

zinb totalApplication    radicalmili_3m   dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust iter(10)

est sto model1

zinb totalApplication   radicalsur_4m     dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model2

zinb totalApplication    moderatesur_4m    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model3

zinb totalApplication   institutionsur_4m    dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model4

zinb totalApplication   radicalsur_4m moderatesur_4m institutionsur_4m  c.(radicalsur_4m)#c.(institutionsur_4m )   dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model5

zinb totalApplication    radicalsur_4m moderatesur_4m institutionsur_4m  c.(  moderatesur_4m)#c.(institutionsur_4m)  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  gdppercap  Totalpop  totalpilots , inflate(  dronemanufacture droneclient  privacy  california  publicadoption   NUniveristy  Nhobbyist  cumuapply  security accidents_2m  ) cluster( statecountycluster) robust

est sto model6

***********************************************************************
Read the data into R
***********************************************************************
library(foreign)
fulldata<-read.dta("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Newdata20180621.dta")
library(MCMCglmm)



results<-MCMCglmm(cbind(NDealio,Ndenovo)~
at.level(trait,1):radicalsur_3m+
at.level(trait,1):moderatesur_3m+
at.level(trait,1):institutionsur_3m+
at.level(trait,1):allradical_4m+
at.level(trait,1):moderatesur_3m*at.level(trait,1):allradical_4m+
at.level(trait,1):institutionsur_3m*at.level(trait,1):allradical_4m+
at.level(trait,1):radicalsur_3m*at.level(trait,1):cumupublicadoption+
at.level(trait,1):moderatesur_3m*at.level(trait,1):cumupublicadoption+
at.level(trait,1):institutionsur_3m*at.level(trait,1):cumupublicadoption+
at.level(trait,1):radicalsur_3m*at.level(trait,1):Hobbyist_p1+
at.level(trait,1):moderatesur_3m*at.level(trait,1):Hobbyist_p1+
at.level(trait,1):institutionsur_3m*at.level(trait,1):Hobbyist_p1+
at.level(trait,1):Hobbyist_p1+
at.level(trait,1):cumupublicadoption+
at.level(trait,1):cumudenovo+
at.level(trait,1):Ndealio_p1  +
at.level(trait,1):radicalmili_4m+
at.level(trait,1):accidents_1m+
at.level(trait,1):dronemanufacture+
at.level(trait,1):NUniveristy+
at.level(trait,1):logpilots+
at.level(trait,1):security+
at.level(trait,1):privacy + 
at.level(trait,1):california+  
at.level(trait,1):gdppercap  +
at.level(trait,1):Totalpop+

at.level(trait,2):dronemanufacture+
at.level(trait,2):NUniveristy+
at.level(trait,2):logpilots+
at.level(trait,2):security+
at.level(trait,2):privacy + 
at.level(trait,2):california+  
at.level(trait,2):gdppercap  +
at.level(trait,2):Totalpop+

at.level(trait,3):radicalsur_3m+
at.level(trait,3):moderatesur_3m+
at.level(trait,3):institutionsur_3m+
at.level(trait,3):allradical_4m+
at.level(trait,3):moderatesur_3m*at.level(trait,3):allradical_4m+
at.level(trait,3):institutionsur_3m*at.level(trait,3):allradical_4m+
at.level(trait,3):radicalsur_3m*at.level(trait,3):cumupublicadoption+
at.level(trait,3):moderatesur_3m*at.level(trait,3):cumupublicadoption+
at.level(trait,3):institutionsur_3m*at.level(trait,3):cumupublicadoption+
at.level(trait,3):radicalsur_3m*at.level(trait,3):Hobbyist_p1+
at.level(trait,3):moderatesur_3m*at.level(trait,3):Hobbyist_p1+
at.level(trait,3):institutionsur_3m*at.level(trait,3):Hobbyist_p1+
at.level(trait,3):Hobbyist_p1+
at.level(trait,3):cumupublicadoption+
at.level(trait,3):cumudenovo+
at.level(trait,3):Ndealio_p1  +
at.level(trait,3):radicalmili_4m+
at.level(trait,3):accidents_1m+
at.level(trait,3):dronemanufacture+
at.level(trait,3):NUniveristy+
at.level(trait,3):logpilots+
at.level(trait,3):security+
at.level(trait,3):privacy + 
at.level(trait,3):california+  
at.level(trait,3):gdppercap  +
at.level(trait,3):Totalpop+


at.level(trait,4):dronemanufacture+
at.level(trait,4):NUniveristy+
at.level(trait,4):logpilots+
at.level(trait,4):security+
at.level(trait,4):privacy + 
at.level(trait,4):california+  
at.level(trait,4):gdppercap+
at.level(trait,4):Totalpop,random =~us(trait):statecountycluster,rcov= ~us(trait):units, family =rep("zipoisson",2),
nitt=7000,burnin=3000,thin=25,data=fulldata)
summary(results)



dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
*****************************************************
merge interaction for radical
*******************************************************

library(foreign)
fulldata<-read.dta("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Newdata20180621.dta")
library(pscl)
fulldata$logpilots<-log(fulldata$totalpilots+1)

Addallradical<-read.dta("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\2_VariableList\\Drone Related Protests\\Allradicalprotest.dta")

fulldata<-merge(fulldata,Addallradical,
by.x=c("year","month","statefips","countyfips"),
by.y=c("year","month","statefips","countyfips"),
all.x=TRUE
)

write.dta(fulldata,file="D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Newdata20180621.dta")

fulldata$allradical_3m<-fulldata$radicalsur_3m+fulldata$radicalmili_3m





results1<-zeroinfl(Ndenovo~
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)



results1<-zeroinfl(Ndenovo~
radicalsur_3m+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)




results1<-zeroinfl(Ndenovo~
moderatesur_3m+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


results1<-zeroinfl(Ndenovo~
institutionsur_3m+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


results1<-zeroinfl(Ndenovo~
radicalsur_3m+
allradical_4m+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)

results1<-zeroinfl(Ndenovo~
moderatesur_3m+
radicalsur_3m+
institutionsur_3m+
allradical_4m+
allradical_4m*moderatesur_3m+
allradical_4m*institutionsur_3m+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


results1<-zeroinfl(Ndenovo~
moderatesur_3m+
radicalsur_3m+
institutionsur_3m+
moderatesur_3m*cumupublicadoption+
radicalsur_3m*cumupublicadoption+
institutionsur_3m*cumupublicadoption+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


results1<-zeroinfl(Ndenovo~
moderatesur_3m+
radicalsur_3m+
institutionsur_3m+
moderatesur_3m*Hobbyist_p1+
radicalsur_3m*Hobbyist_p1+
institutionsur_3m*Hobbyist_p1+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


summary(results1)



results1<-zeroinfl(Ndenovo~


moderatesur_3m+
radicalsur_3m+
institutionsur_3m+

allradical_4m+
allradical_4m*moderatesur_3m+
allradical_4m*institutionsur_3m+


moderatesur_3m*cumupublicadoption+
radicalsur_3m*cumupublicadoption+
institutionsur_3m*cumupublicadoption+

moderatesur_3m*Hobbyist_p1+
radicalsur_3m*Hobbyist_p1+
institutionsur_3m*Hobbyist_p1+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


results<-zeroinfl(Ndenovo~

temperatureIV  +
temperatureIVmoderatesur+
temperatureIVinstitutional+

allradical_3m+
allradical_3m*temperatureIVmoderatesur+
allradical_3m*temperatureIVinstitutional+

temperatureIVmoderatesur*cumupublicadoption+
temperatureIV *cumupublicadoption+
temperatureIVinstitutional*cumupublicadoption+

temperatureIVmoderatesur*Hobbyist_p1+
temperatureIV*Hobbyist_p1+
temperatureIVinstitutional*Hobbyist_p1+

Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)

summary(results)

*************************************************
more than one events happen need to use poisson model
************************************************
results1<-glm(radicalsur_3m~as.character(temperaturecat)+as.character(rainfallcut)+AntigunMov+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop+newid
 ,family="poisson",data = fulldata)

fulldata$temperatureIV<- results1$fitted.values

summary(fulldata$temperatureIVmoderatesur)

results2<-glm(moderatesur_3m~as.character(temperaturecat)+as.character(rainfallcut)+AntigunMov+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop+newid
 ,family="poisson",data = fulldata)
fulldata$temperatureIVmoderatesur<- results2$fitted.values

results3<-glm(institutionsur_3m~as.character(temperaturecat)+as.character(rainfallcut)+AntigunMov+
Hobbyist_p1+
cumupublicadoption+
cumudenovo+
Ndealio_p1  +

radicalmili_4m+
accidents_1m+
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop+newid
 ,family="poisson",data = fulldata)
fulldata$temperatureIVinstitutional<- results3$fitted.values





**********************************************
calculate cumulative de novo and de alio firms
**************************************************
cumulativefunction<-function(input){
mm<-matrix(0, nrow=nrow(input), ncol=nrow(input))
mm<-lower.tri(mm)
results<-mm%*%input[,46]
output<-paste(results, collapse=",")
return(output)
}
library(plyr)
fulldata<-fulldata[order(fulldata$statefips, fulldata$countyfips, fulldata$year, fulldata$month),]
results<-ddply(fulldata,.(year,month),cumulativefunction)
fulldata$cumuhobbyists<-as.numeric(as.matrix(unlist(strsplit(results[,3],","))))

write.dta(fulldata,file="F:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Data_20180621.dta")


**********************************************
calculate cumulative public adoption
**************************************************
cumulativefunction<-function(input){
mm<-matrix(0, nrow=nrow(input), ncol=nrow(input))
mm<-lower.tri(mm)
results<-mm%*%input[,9]
output<-paste(results, collapse=",")
return(output)
}
library(plyr)
fulldata<-fulldata[order(fulldata$statefips, fulldata$countyfips, fulldata$year, fulldata$month),]
results<-ddply(fulldata,.(year,month),cumulativefunction)
fulldata$cumupublicadoption<-as.numeric(as.matrix(unlist(strsplit(results[,3],","))))

write.dta(fulldata,file="F:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Data_20180621.dta")




*******************************************
last period de novo and de alio and pub adoption
*******************************************
fulldata<-fulldata[order(fulldata$statefips, fulldata$countyfips, fulldata$year, fulldata$month),]

lagoneperiod<-function(input){
mm<-c(0,input[,7])
mm<-mm[1:nrow(input)]
mm<-paste(mm,collapse=",")
return(mm)
}
library(plyr)
results<-ddply(fulldata,.(statefips, countyfips), lagoneperiod)
fulldata$Ndealio_p1<-as.numeric(as.matrix(unlist(strsplit(results[,3],","))))

lagoneperiod<-function(input){
mm<-c(0,input[,9])
mm<-mm[1:nrow(input)]
mm<-paste(mm,collapse=",")
return(mm)
}
library(plyr)
results<-ddply(fulldata,.(statefips, countyfips), lagoneperiod)
fulldata$Pubadoption_p1<-as.numeric(as.matrix(unlist(strsplit(results[,3],","))))


lagoneperiod<-function(input){
mm<-c(0,input[,10])
mm<-mm[1:nrow(input)]
mm<-paste(mm,collapse=",")
return(mm)
}
library(plyr)
results<-ddply(fulldata,.(statefips, countyfips), lagoneperiod)
fulldata$DeNOVO_p1<-as.numeric(as.matrix(unlist(strsplit(results[,3],","))))




lagoneperiod<-function(input){
mm<-c(0,input[,46])
mm<-mm[1:nrow(input)]
mm<-paste(mm,collapse=",")
return(mm)
}
library(plyr)
results<-ddply(fulldata,.(statefips, countyfips), lagoneperiod)
fulldata$Hobbyist_p1<-as.numeric(as.matrix(unlist(strsplit(results[,3],","))))


*******************************************************
Summary Statistics

******************************************************
sum NDealio Ndenovo moderatesur_3m radicalsur_3m institutionsur_3m allradical_4m Hobbyist_p1 cumupublicadoption cumudenovo Ndealio_p1   radicalmili_4m accidents_1m dronemanufacture NUniveristy logpilots security privacy california gdppercap Totalpop


cor NDealio Ndenovo   moderatesur_3m radicalsur_3m institutionsur_3m allradical_4m Hobbyist_p1 cumupublicadoption cumudenovo Ndealio_p1   radicalmili_4m accidents_1m dronemanufacture NUniveristy logpilots security privacy california gdppercap Totalpop



******************************************************
Read the data and conduct simple analyses

******************************************************

library(foreign)
fulldata<-read.dta("Newdata20180621.dta")

attachhead<-fulldata[,1:4]

stationrainfall<-read.table("countiesstationwithdata.csv",
sep=",",header=TRUE)



library(moments)

# add temperature instrumental variable
rainfall<-read.table("Rainfall2014_2016.csv",sep=",",header=TRUE)
temperaturemax<-read.table("Temperaturemax2014_2016.csv",sep=",",header=TRUE)
temperaturemin<-read.table("Temperaturemin2014_2016.csv",sep=",",header=TRUE)



calmonthlymoments<-function(input, compare,stationrainfall){

station<-stationrainfall[which(
stationrainfall$statefips==as.numeric(as.matrix(input[3]))& 
stationrainfall$countyfips==as.numeric(as.matrix(input[4]))),]$station

compareamount<-which(as.character(as.matrix(compare[,4]))
%in%as.character(as.matrix(station)) & 
as.numeric(as.matrix(compare[,1]))==as.numeric(as.matrix(input[1]))&
as.numeric(as.matrix(compare[,2]))==as.numeric(as.matrix(input[2])))
if(length(compareamount)!=0){
tempfirstmoment<-moment(compare[compareamount,5],order=1,absolute=TRUE)
tempsecondmoment<-moment(compare[compareamount,5],order=2,absolute=TRUE)
tempthirdmoment<-moment(compare[compareamount,5],order=3,absolute=TRUE)
}else{
tempfirstmoment<-0
tempsecondmoment<-0
tempthirdmoment<-0
}

output<-data.frame(tempfirstmoment)
output<-cbind(output,tempsecondmoment, tempthirdmoment)
return(output)
}
library(plyr)


rainfallmoment<-apply(attachhead,1,calmonthlymoments,rainfall,stationrainfall)
rainfallmoment<-do.call(rbind,rainfallmoment)
output<-cbind(attachhead,rainfallmoment)
write.table(output,file="Rainfallmoment.csv",sep=",",row.names=FALSE)

temperaturemaxmoment<-apply(attachhead,1,calmonthlymoments,temperaturemax,stationrainfall)
temperaturemaxmoment<-do.call(rbind,temperaturemaxmoment)
output<-cbind(attachhead,temperaturemaxmoment)
write.table(output,file="Temperaturemaxmoment.csv",sep=",",row.names=FALSE)


temperatureminmoment<-apply(attachhead,1,calmonthlymoments,temperaturemin,stationrainfall)
temperatureminmoment<-do.call(rbind,temperatureminmoment)
output<-cbind(attachhead,temperatureminmoment)
write.table(output,file="Temperatureminmoment.csv",sep=",",row.names=FALSE)

*****************************************************************
attach new IV to original data
*****************************************************************

library(foreign)
fulldata<-read.dta("Newdata20180621.dta")
rainfall<-read.table("Rainfallmoment.csv",sep=",",header=TRUE)
temperaturemax<- read.table("Temperaturemaxmoment.csv",sep=",",header=TRUE)
temperaturemin<- read.table("Temperatureminmoment.csv",sep=",",header=TRUE)
colnames(temperaturemin)<-c("year", "month", "statefips", "countyfips",
"tempfirstmin","tempsecondmin","tempthirdmin")

fulldata<-merge(fulldata,temperaturemax,
by.x=c("year","month","statefips","countyfips"),
by.y=c("year","month","statefips","countyfips"),all.x=TRUE)

fulldata<-merge(fulldata,temperaturemin,
by.x=c("year","month","statefips","countyfips"),
by.y=c("year","month","statefips","countyfips"),all.x=TRUE)






*************************************************
Instrumental Variable
************************************************
results1<-glm(radicalsur_3m~
tempfirstmoment+ tempsecondmoment+ 
tempfirstmin+ tempsecondmin 
 ,family="poisson",data = fulldata)

fulldata$temperatureIV<- results1$fitted.values


results2<-glm(moderatesur_3m~tempfirstmoment+ tempsecondmoment+ 
tempfirstmin+ tempsecondmin ,family="poisson",data = fulldata)
fulldata$temperatureIVmoderatesur<- results2$fitted.values

results3<-glm(institutionsur_3m~tempfirstmoment+ tempsecondmoment+ 
tempfirstmin+ tempsecondmin ,family="poisson",data = fulldata)
fulldata$temperatureIVinstitutional<- results3$fitted.values

fulldata$antisurveillance_3m<-fulldata$radicalsur_3m+
fulldata$moderatesur_3m+fulldata$institutionsur_3m

results4<-glm(radicalmili_3m ~tempfirstmoment+ tempsecondmoment+ 
tempfirstmin+ tempsecondmin ,family="poisson",data = fulldata)

fulldata$militaryIV<- results4$fitted.values

results5<-glm(antisurveillance_3m~tempfirstmoment+ tempsecondmoment+ 
tempfirstmin+ tempsecondmin ,family="poisson",data = fulldata) 

fulldata$antisurveillanceIV<- results5$fitted.values






fulldata$testdiversity <-1- fulldata$diversity_3m
fulldata[which(fulldata$testdiversity==1), ]$testdiversity<-0
fulldata[which(is.na(fulldata$testdiversity)), ]$testdiversity<-0


results6<-lm(testdiversity~ 
radicalmili_3m+
radicalsur_3m+
moderatesur_3m+
institutionsur_3m ,data = fulldata) 

fulldata$testdiversityIV<- results6$fitted.values

results7<-glm(allradical_3m~tempfirstmoment+ tempsecondmoment+ 
tempfirstmin+ tempsecondmin ,family="poisson",data = fulldata) 
fulldata$surveillancespillIV<- results7$fitted.values


write.dta(fulldata,"D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata_20180708.dta")


********************************************************
Main Zero Inflated Model

********************************************************
library(foreign)
fulldata<-read.dta("E:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata_20180708.dta")

library(pscl)

militaryIV+
antisurveillanceIV+
temperatureIV  +
temperatureIVmoderatesur+
temperatureIVinstitutional+
testdiversityIV+
surveillancespillIV+
surveillancespillIV*temperatureIVmoderatesur+

radicalmili_3m+
antisurveillance_3m+
radicalsur_3m+
moderatesur_3m+
institutionsur_3m+
testdiversity+

allradical_4m+
allradical_4m*moderatesur_3m+


DeNOVO_p1+
Ndealio_p1  +

results1<-zeroinfl(Ndenovo~

militaryIV+
temperatureIV  +
temperatureIVmoderatesur+
temperatureIVinstitutional+

surveillancespillIV+
surveillancespillIV*temperatureIVmoderatesur+

Hobbyist_p1+
cumupublicadoption+

DeNOVO_p1+
Ndealio_p1  +
accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+
security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


at.level(trait,1):militaryIV+
at.level(trait,1):temperatureIV  +
at.level(trait,1):temperatureIVmoderatesur+
at.level(trait,1):temperatureIVinstitutional+
at.level(trait,1):testdiversityIV+
at.level(trait,1):surveillancespillIV+
at.level(trait,1):surveillancespillIV*at.level(trait,1):temperatureIVmoderatesur+

at.level(trait,3):militaryIV+
at.level(trait,3):temperatureIV  +
at.level(trait,3):temperatureIVmoderatesur+
at.level(trait,3):temperatureIVinstitutional+
at.level(trait,3):testdiversityIV+
at.level(trait,3):surveillancespillIV+
at.level(trait,3):surveillancespillIV*at.level(trait,3):temperatureIVmoderatesur+




library(MCMCglmm)
results<-MCMCglmm(cbind(NDealio,Ndenovo)~

at.level(trait,1):temperatureIVmoderatesur+
at.level(trait,1):Hobbyist_p1+
at.level(trait,1):cumupublicadoption+
at.level(trait,1):DeNOVO_p1+
at.level(trait,1):Ndealio_p1  +

at.level(trait,1):accidents_1m+
at.level(trait,1):dronemanufacture+
at.level(trait,1):NUniveristy+
at.level(trait,1):logpilots+
at.level(trait,1):security+
at.level(trait,1):privacy + 
at.level(trait,1):california+  
at.level(trait,1):gdppercap  +
at.level(trait,1):Totalpop+

at.level(trait,2):dronemanufacture+
at.level(trait,2):NUniveristy+
at.level(trait,2):logpilots+
at.level(trait,2):security+
at.level(trait,2):privacy + 
at.level(trait,2):california+  
at.level(trait,2):gdppercap  +
at.level(trait,2):Totalpop+


at.level(trait,3):temperatureIVmoderatesur+


at.level(trait,3):testdiversityIV+
at.level(trait,3):Hobbyist_p1+
at.level(trait,3):cumupublicadoption+
at.level(trait,3):DeNOVO_p1+
at.level(trait,3):Ndealio_p1  +

at.level(trait,3):accidents_1m+
at.level(trait,3):dronemanufacture+
at.level(trait,3):NUniveristy+
at.level(trait,3):logpilots+
at.level(trait,3):security+
at.level(trait,3):privacy + 
at.level(trait,3):california+  
at.level(trait,3):gdppercap  +
at.level(trait,3):Totalpop+


at.level(trait,4):dronemanufacture+
at.level(trait,4):NUniveristy+
at.level(trait,4):logpilots+
at.level(trait,4):security+
at.level(trait,4):privacy + 
at.level(trait,4):california+  
at.level(trait,4):gdppercap+
at.level(trait,4):Totalpop,random =~us(trait):statecountycluster,rcov= ~us(trait):units, family =rep("zipoisson",2),
nitt=5000,burnin=3000,thin=25,data=fulldata)
summary(results)





*********************************************
Test whether de alio firms are similar or different from de novo firms
b[1]-b[2]>0 
************************************************

library(nlWaldTest)
library(matrixStats)
covariancematrix<- colSds(results1$Sol)^2
mean<- colSums(results1$Sol)/80
mm<-matrix(0,nrow=length(mean),ncol=length(mean))
diag(mm)<-covariancematrix
nlWaldtest(texts="b[2]-b[24]=0.1", coeff=mean, Vcov=mm)



*********************************************
Test the inequality impact of three types of protests
************************************************
library(foreign)
fulldata<-read.dta("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata_20180704.dta")
library(pscl)



library(nlWaldTest)
library(matrixStats)
mm<- results1$vcov[1:length(results1$coefficients$count),1:length(results1$coefficients$count)]


nlWaldtest(texts="b[3]-b[4]=0.1", coeff=results1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[4]-b[5]=0.1", coeff=results1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[3]-b[5]=0.1", coeff=results1$coefficients$count, Vcov=mm)


*******************************************
Diversity of protests with prediction of diversity
*******************************************
gen  antisurveillance_3m=radicalsur_3m+ moderatesur_3m +institutionsur_3m 

sum NDealio Ndenovo radicalmili_3m antisurveillance_3m radicalsur_3m moderatesur_3m institutionsur_3m testdiversity  allradical_4m tempfirstmoment tempsecondmoment tempfirstmin tempsecondmin Hobbyist_p1 cumupublicadoption  DeNOVO_p1 Ndealio_p1 accidents_1m dronemanufacture NUniveristy logpilots security privacy  california gdppercap Totalpop

cor NDealio Ndenovo radicalmili_3m antisurveillance_3m radicalsur_3m moderatesur_3m institutionsur_3m testdiversity  allradical_4m tempfirstmoment tempsecondmoment tempfirstmin tempsecondmin Hobbyist_p1 cumupublicadoption  DeNOVO_p1 Ndealio_p1 accidents_1m dronemanufacture NUniveristy logpilots security privacy  california gdppercap Totalpop

#####################################################################
***********************************************************
New Analyses 20180712
************************************************************
########################################################################

library(foreign)
fulldata<-read.dta("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata_20180704.dta")
library(pscl)

radicalmili_3m+
antisurveillance_3m+
radicalsur_3m+
moderatesur_3m+
institutionsur_3m+
testdiversity+

allradical_4m+
allradical_4m*moderatesur_3m+
moderatesur_3m+
instest_3m+

moderatecounty_3m+

stateradical_3m.y+
stateradical_3m.y*moderatecounty_4m+

fulldata$combinemoderateinstitutional<-fulldata$moderatecounty_3m+
fulldata$instest_3m

results<-lm()

radicalcounty_4m
moderatecounty_4m
stateradical_4m.y 
radicalcounty_3m  


moderatecounty_3m+
statemoderate_3m*radicalcounty_3m+


results1<-zeroinfl(totalApplication ~
radicalcounty_3m +
moderatecounty_3m+

instest_4m+
Hobbyist_p1+
cumupublicadoption+
accident_1m+
cumuapply+
dronemanufacture+
NUniveristy+
logpilots+
security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)

 
fulldata$test1<-fulldata$test*fulldata$radicalsur_4m
summary(fulldata$test1)
cor(fulldata$test, fulldata$institutionsur_3m) 

#merge with new antiwar protests
library(foreign)
antiwarprotests<-read.dta("antiwartimelag.dta")
fulldata<-merge(fulldata,antiwarprotests,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)



institutionalrevise<-read.dta("institutionalantisurv.dta")
colnames(institutionalrevise)<-c("instest_1m","instest_2m","instest_3m","instest_4m","statefips", "year", "month", "countyfips")
fulldata<-merge(fulldata,institutionalrevise,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)







radicalcounty<-read.dta("radicalcounty.dta")

fulldata<-merge(fulldata,radicalcounty,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)

moderatecounty<-read.dta("moderatecounty.dta")

fulldata<-merge(fulldata,moderatecounty,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)

stateradical


stateradical<-read.dta("stateradical.dta")

fulldata<-merge(fulldata,stateradical,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)


statemoderate<-read.dta("statemoderate.dta")

fulldata<-merge(fulldata,statemoderate,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)

************************************
Weighted radical protests
***************************************
radicalcounty_3m +
moderatecounty_3m+
instest_3m+
stateradical_4m.y+
allradical_4m+

radicalmili_3m+
antisurveillance_3m+
radicalsur_3m+
moderatesur_3m+
institutionsur_3m+
testdiversity+

fulldata$combine<-fulldata$moderatecounty_3m+fulldata$instest_3m


results1<-zeroinfl(totalApplication ~
radicalcounty_4m +
combine+
stateradical_4m.y+
stateradical_4m.y*combine+
Hobbyist_p1+
cumupublicadoption+

accidents_1m+

dronemanufacture+
NUniveristy+
logpilots+
security+
privacy + 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE)


 


************************************
Three different table
***************************************

fulldata<-read.table("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata20180716.csv",sep=",",header=TRUE)

radicalcounty_4m+
moderatecounty_4m+
instest_4m+

NDealio Ndenovo   moderatesur_3m radicalsur_3m institutionsur_3m
 allradical_4m Hobbyist_p1 cumupublicadoption cumudenovo Ndealio_p1  
 radicalmili_4m accidents_1m dronemanufacture NUniveristy logpilots 
 security privacy california gdppercap Totalpop



stateradical_2m.x 
statemoderate_2m (within one year)
institutionalstate_2m

stateradical_4m.x 
statemoderate_4m 
institutionalstate_4m
stateradicalshift (radical protests shift)
statemoderate_2m.x+


 fulldata$radicalshiftdummy<-0
 
fulldata[which(fulldata$stateradicalshift!=0),]$radicalshiftdummy<-1

institutionalstate<-read.dta("institutionalstate.dta")

fulldata<-merge(fulldata,institutionalstate,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)


write.table(fulldata, file="D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata20180716.csv",
sep=",",row.names=FALSE)


stateradicalshift<-read.dta("stateradicalshift.dta")

fulldata<-merge(fulldata,stateradicalshift,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month", "countyfips"),all.x=TRUE)






library(pscl)

results1<-zeroinfl(totalApplication ~
antisurveillance+
Hobbyist_p1+
cumupublicadoption+
accidents_4m+
cumuapply+
dronemanufacture+
NUniveristy+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE) 
 
 
***********************************
Finalize results 20180718
***************************************
fulldata<-read.table("D:\\All_Projects\\Project_Lori_SocialMovementImpact\\3_FinalDataset\\Fulldata20180716.csv",sep=",",header=TRUE)

fulldata$combine<-fulldata$moderatecounty_4m+fulldata$instest_4m
fulldata$antisurveillance<-fulldata$radicalcounty_4m+fulldata$moderatecounty_4m+fulldata$instest_4m
fulldata$cumuapplication_p1<-fulldata$DeNOVO_p1+fulldata$Ndealio_p1


library(pscl)
NDealio,Ndenovo


results1<-zeroinfl(totalApplication~
 radicalmili_4m+
Hobbyist_p1+
cumupublicadoption+
accidents_4m+
cumuapply+
dronemanufacture+
NUniveristy+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap  +
Totalpop|
dronemanufacture+
NUniveristy+
logpilots+

security+
privacy + 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE) 
 
 
 

 totalApplication
 antiwar_4m
 radicalmili_4m+
 antisurveillance+
 radicalcounty_4m+
moderatecounty_4m+
instest_4m+
combine+
combine* radicalcounty_4m+
 
 
 


library(MCMCglmm)
results<-MCMCglmm(cbind(NDealio,Ndenovo)~
at.level(trait,1): antiwar_4m+
at.level(trait,1):combine+
at.level(trait,1): radicalcounty_4m+

at.level(trait,1):combine*at.level(trait,1): radicalcounty_4m+

at.level(trait,1):Hobbyist_p1+
at.level(trait,1):cumupublicadoption+
at.level(trait,1):cumuapply+
at.level(trait,1):accidents_4m+
at.level(trait,1):dronemanufacture+
at.level(trait,1):NUniveristy+
at.level(trait,1):logpilots+
at.level(trait,1):statesecurity+
at.level(trait,1):stateprivacy + 
at.level(trait,1):california+  
at.level(trait,1):gdppercap  +
at.level(trait,1):Totalpop+

at.level(trait,2):dronemanufacture+
at.level(trait,2):NUniveristy+
at.level(trait,2):logpilots+
at.level(trait,2):security+
at.level(trait,2):privacy + 
at.level(trait,2):california+  
at.level(trait,2):gdppercap  +
at.level(trait,2):Totalpop+

at.level(trait,3): antiwar_4m+
at.level(trait,3):combine+
at.level(trait,3): radicalcounty_4m+
at.level(trait,3):combine*at.level(trait,3): radicalcounty_4m+


at.level(trait,3):Hobbyist_p1+
at.level(trait,3):cumupublicadoption+
at.level(trait,3):cumuapply+
at.level(trait,3):accidents_4m+
at.level(trait,3):dronemanufacture+
at.level(trait,3):NUniveristy+
at.level(trait,3):logpilots+
at.level(trait,3):statesecurity+
at.level(trait,3):stateprivacy + 
at.level(trait,3):california+  
at.level(trait,3):gdppercap  +
at.level(trait,3):Totalpop+


at.level(trait,4):dronemanufacture+
at.level(trait,4):NUniveristy+
at.level(trait,4):logpilots+
at.level(trait,4):security+
at.level(trait,4):privacy + 
at.level(trait,4):california+  
at.level(trait,4):gdppercap+
at.level(trait,4):Totalpop,random =~us(trait):statecountycluster,rcov= ~us(trait):units, family =rep("zipoisson",2),
nitt=5000,burnin=3000,thin=25,data=fulldata)
summary(results)


****************************************
Data Recover
******************************************
library(foreign)
fulldata<-read.dta("Fulldata_20180717.dta")

radicalmili_4m+
controlmilitary+

 radicalcounty_4m+
controlsurveillance+

 moderatecounty_4m+
controlmoderate+


instest_4m+
controlinstitution+

 radicalcounty_4m+
 combine+
controlsurveillance+
controlmoderate+
controlinstitution+

fulldata$combine<-fulldata$instest_4m+fulldata$moderatecounty_4m

library(pscl)

controlsurveillance+
controlcombine+



results1<-zeroinfl(totalapplication~
radicalcounty_4m+
combine+

controlsurveillance+
controlcombine+


cumuapply+
cumupublicadoption+
accidents_4m+
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap+
newtotalpop
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 

 
 controlsurveillance+
controlcombine+

#add control function
results2<-lm(radicalmili_4m~ rainfall+tempfirstmin+
 tempsecondmin+
 as.character(statefips)+
 as.character(newid),data=fulldata)
 
 fulldata$controlmilitary<-results2$residual
 
 
 results3<-lm( radicalcounty_4m~ rainfall+tempfirstmin+
 tempsecondmin+
 as.character(statefips)+
 as.character(newid),data=fulldata)
 
 fulldata$controlsurveillance<-results3$residual
 
 moderatecounty_4m+
instest_4m+

  results3<-lm( moderatecounty_4m~ rainfall+tempfirstmin+
 tempsecondmin+
 as.character(newid)
 ,data=fulldata)
 
 fulldata$controlmoderate<-results3$residual
 
 
   results3<-lm( instest_4m~ rainfall+tempfirstmin+
 tempsecondmin+
 as.character(newid)+
 as.character(statefips)
 ,data=fulldata)
 
 fulldata$controlinstitution<-results3$residual
 
  
   results3<-lm(combine~ rainfall+tempfirstmin+
 tempsecondmin+
 as.character(newid)+
 as.character(statefips)
 ,data=fulldata)
 
 fulldata$controlcombine<-results3$residual
 
 
 
fulldata$newtotalpop<-log(as.numeric(as.matrix(fulldata$totalpop)))

radicalmili_4m
radicalcounty_4m
moderatecounty_4m
summary(results1)


**************************************
Draw Interaction Effect
*********************************************

coefficients<- results1$coefficients$count
meanofvariable<-colMeans(results1$x$count)

mm<-matrix(0,nrow=2, ncol=8)
for(i in 1:2){
for(j in 1:8){
meanofvariable[2]<-i-1
meanofvariable[3]<-j-1
meanofvariable[length(meanofvariable)]<-(i-1)*(j-1)
mm[i,j]<-exp(t(coefficients)%*%meanofvariable)
}}

write.table(mm,file="graph1.csv",sep=",",row.names=FALSE)

zz <- plm(log(gsp) ~ log(pcap) + log(pc) + log(emp) + unemp,
data = Produc, index = c("state","year"))


mm<-summary(results4)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients)),
data.frame(cbind("Obs.",nrow(fulldata))),
data.frame(cbind("R square", round( 
as.numeric(as.matrix(mm$r.squared) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

**************************************
stata code
*********************************************




xtset  statecountycluster newid

xtreg  logtotalapplication radicalmili_4m controlmilitary  cumupublicadoption  statesecurity stateprivacy, fe

est sto model1

xtreg   logtotalapplication radicalcounty_4m  controlsurveillance cumuapply accident_4m cumupublicadoption  statesecurity stateprivacy, fe

est sto model2


xtreg  logtotalapplication radicalcounty_4m combine  controlsurveillance controlcombine  cumupublicadoption statesecurity stateprivacy, fe

est sto model3

xtreg   logtotalapplication radicalcounty_4m combine  controlsurveillance controlcombine  cumupublicadoption statesecurity stateprivacy c.( radicalcounty_4m)#c.(combine), fe

est sto model4

esttab model1 model2 model3 model4  using ier.rtf, se sca(ll) star(* 0.05 ** 0.01 *** 0.001) replace



*****************************
no fixed time effect
********************************
library(foreign)
fulldata<-read.dta("Fulldata_20180717.dta")

radicalmili_4m+
controlmilitary+

 radicalcounty_4m+
controlsurveillance+

 moderatecounty_4m+
controlmoderate+


instest_4m+
controlinstitution+

 radicalcounty_4m+
 combine+
controlsurveillance+
controlmoderate+
controlinstitution+

fulldata$combine<-fulldata$instest_4m+fulldata$moderatecounty_4m

library(pscl)

controlsurveillance+
controlcombine+



results1<-zeroinfl(totalapplication~
 radicalcounty_4m*combine+
 combine+as.character(statefips)+
 as.character(newid)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 

 
 write.table(fulldata, file="Fulldata20180722.csv",
sep=",",row.names=FALSE)


cumupublicadoption+
accidents_4m+
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap+
newtotalpop+


****************************************
Edit 2080728 finalize the results
*************************************
library(foreign)
fulldata<-read.dta("Fulldata20180728.dta")

editeddata<-read.table("D:\\Protest Project\\Fulldata20180716.csv",sep=",",header=TRUE)
data<-editeddata[,1:4]
data$Hobbyist_p1<-editeddata$Hobbyist_p1
data$NUniveristy<-editeddata$NUniveristy
data$Totalpop<-editeddata$Totalpop
data$Ndealio_p1<-editeddata$Ndealio_p1
data$Pubadoption_p1<-editeddata$Pubadoption_p1
data$DeNOVO_p1<-editeddata$DeNOVO_p1
data$Hobbyist_p1<-editeddata$Hobbyist_p1


data$NDealio <-editeddata$NDealio 
data$NUniveristy <-editeddata$NUniveristy 
data$publicadoption <-editeddata$publicadoption 
data$Ndenovo<-editeddata$Ndenovo

fulldata<-merge(fulldata,data,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)

fulldata$totalapplication<-fulldata$NDealio +fulldata$Ndenovo


#variable selection
summary(fulldata$countysur_600d*fulldata$radicalmili_600d)
summary(fulldata$countysur_600d*fulldata$countymili_600d)
summary(fulldata$countysur_600d*fulldata$radicalcounty_4m)

cor(fulldata$Pubadoption_p1,fulldata$countysur_600d)

write.table(fulldata,file="Fulldata20180728.csv",sep=",",row.names=FALSE)

fulldata<-read.table("Fulldata20180728.csv",sep=",",header=TRUE)
checkfile<-read.table("Fulldata20180727.csv",sep=",",header=TRUE)
checkfile1<-checkfile[,1:4]
checkfile1$checkapply<-checkfile$totalapplication
checkfile1$cumupublicadoption<-checkfile$cumupublicadoption
fulldata<-merge(fulldata,checkfile1,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)

fulldata$antisurveillance<-fulldata$statesur_600d+fulldata$countysur_600d


#Test the fitness of models
library(pscl)
m1<-zeroinfl(totalapplication~
countymili_600d+
Hobbyist_p1+
Pubadoption_p1+
accidents_4m+
cumuapply+
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap  +
Totalpop+
as.character(newid)|
dronemanufacture+
NUniveristy+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap  +
Totalpop
 , data=fulldata, dist = "poisson", EM = TRUE) 
 

 
m2<-glm(totalapplication~
countysur_600d+
cumuapply+
cumupublicadoption+
accidents_4m+
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop +
as.character(newid),family="poisson",data=fulldata)



vuong(m1, m2, digits = getOption("digits"))


#Test the validity of instrumental variable



radicalmili_600d
radicalcounty_4m+

countymili_600d*radicalcounty_4m+

fulldata$antimilitary<-fulldata$nationalmili_600d+fulldata$countymili_600d
fulldata$antisurveillance<-fulldata$statesur_600d+fulldata$countysur_600d+fulldata$nationsur_600d

write.table(fulldata,file="Fulldata20180727.csv",sep=",",row.names=FALSE)


fulldata<-read.table("Fulldata20180727.csv",sep=",",header=TRUE)

countymili_600d+
countymiliresidual+

radicalmili_600d+
radicalmiliresidual+

antisurveillance+
antisurveillanceresidual+

radicalcounty_4m+
radicalsurveilresidual+



library(pscl)

cumupublicadoption+

results1<-zeroinfl(totalapplication~
countymili_600d+
cumuapply+

accidents_4m+
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop +
as.character(newid)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=checkfile, dist = "poisson", EM = TRUE) 
 
 summary(results1)
 
 
 
 
 
 library(foreign)
library(pscl)
require(ffbase)
require(LaF)
require(ETLUtils)
library(xtable)
require(biglm)
library(psych)

library(xtable)


cleardata<-function(input){
names<-rownames(input)
final<-matrix("",nrow=nrow(input)*2,ncol=2)
j=1
for(i in 1:nrow(input)){
st<-paste("(",round(as.numeric(as.matrix(input[i,2])),digits=5),")",sep="")
if(!is.na(input[i,4])){
if(as.numeric(input[i,4])<=0.001){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"***",sep="")
}
if(as.numeric(input[i,4]<=0.01&as.numeric(input[i,4])>0.001 )){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"**",sep="")
}
if(as.numeric(input[i,4]<=0.05&&as.numeric(input[i,4])>0.01)){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"*",sep="")
}
if(as.numeric(input[i,4]<=0.1&&as.numeric(input[i,4])>0.05)){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"+",sep="")
}
if(as.numeric(input[i,4])>0.1){
coe<-round(as.numeric(input[i,1]),digits=5)}
}else{
coe<-"NA"
}
final[j,1]<-names[i]
final[j,2]<-coe
final[j+1,2]<-st
j<-j+2
}
return(final)
}


# write zero inflation model
mm<-summary(results1)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients$count)),
data.frame(cleardata(mm$coefficients$zero)),
data.frame(cbind("Obs.",sum( mm$n))),
data.frame(cbind("log lik.", round( 
as.numeric(as.matrix(mm$loglik) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

 
****************************************
Edit 2080728 finalize the results
*************************************
library(foreign)
fulldata<-read.dta("Fulldata20180728.dta")
 editeddata<-read.table("D:\\Protest Project\\Fulldata20180716.csv",sep=",",header=TRUE)
data<-editeddata[,1:4]
data$Hobbyist_p1<-editeddata$Hobbyist_p1
data$NUniveristy<-editeddata$NUniveristy
data$Totalpop<-editeddata$Totalpop
data$Ndealio_p1<-editeddata$Ndealio_p1
data$Pubadoption_p1<-editeddata$Pubadoption_p1
data$DeNOVO_p1<-editeddata$DeNOVO_p1
data$Hobbyist_p1<-editeddata$Hobbyist_p1
 data$NDealio <-editeddata$NDealio 
data$NUniveristy <-editeddata$NUniveristy 
data$publicadoption <-editeddata$publicadoption 
data$Ndenovo<-editeddata$Ndenovo

 fulldata<-merge(fulldata,data,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)

 fulldata$totalapplication<-fulldata$NDealio +fulldata$Ndenovo
 #variable selection
summary(fulldata$countysur_600d*fulldata$radicalmili_600d)
summary(fulldata$countysur_600d*fulldata$countymili_600d)
summary(fulldata$countysur_600d*fulldata$radicalcounty_4m)
 cor(fulldata$Pubadoption_p1,fulldata$countysur_600d)
 write.table(fulldata,file="Fulldata20180728.csv",sep=",",row.names=FALSE)
 
 
 fulldata<-read.table("Fulldata20180728.csv",sep=",",header=TRUE)
checkfile<-read.table("Fulldata20180727.csv",sep=",",header=TRUE)
checkfile1<-checkfile[,1:4]
checkfile1$checkapply<-checkfile$totalapplication

checkfile1$cumupublicadoption<-checkfile$cumupublicadoption

fulldata<-merge(fulldata,checkfile1,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)



 fulldata$antisurveillance<-fulldata$statesur_600d+fulldata$countysur_600d
 
 
fulldata$testapplication<-fulldata$napplication-fulldata$publicadoption-fulldata$NUniveristy

fulldata[which(fulldata$testapplication<0),]$testapplication<-0


add<-checkfile[,1:4]
add$newtotalpop<-checkfile$newtotalpop
fulldata<-merge(fulldata,add,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)


 write.table(fulldata,file="Fulldata20180729.csv",sep=",",row.names=FALSE)
 
 fulldata<-read.table("Fulldata20180729.csv",sep=",",header=TRUE)
 
 **************
 variables
 ***********
gdppercap  +
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
california+ 
as.character(newid)


 
 countymili_600d+
countymiliresidual+

radicalmili_600d+
radicalmiliresidual+

antisurveillance+
antisurveillanceresidual+

radicalcounty_4m+
radicalsurveilresidual+


countysur_600d

 #Test the fitness of models



library(pscl)
m1<-zeroinfl(testapplication~
countymiliIV+
gdppercap  +
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
california+  
as.character(newid)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 
 
 
summary(m1)


m1<-zeroinfl(testapplication~
   countymili_600d+
   countymiliresidual+
   gdppercap  +
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(statefips)+
as.character(month)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 
 
 
summary(m1)
 
 
m2<-glm(testapplication~
 countymili_600d+
countymiliresidual+
gdppercap  +
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
california+  
as.character(newid),family="poisson",data=fulldata)


 vuong(m1, m2, digits = getOption("digits"))

 Sys.getenv("R_LIBS_USER")
[1] "C:\\Users\\wang547\\Documents/R/win-library/3.4"


install.packages("MASS")
install.packages("lattice")
install.packages("msme")
library(msme)
library(MASS)
library(lattice)
P__disp(m2)
  
library(pscl)





library(plm)
results1<-plm(countymili_600d~tempfirstmin +tempsecondmin,data=fulldata, model ="within",
index = c("statecountycluster","newid"))

fulldata$countymiliIV<-fulldata$countymili_600d- results1$residuals
 
 


 # write zero inflation model
mm<-summary(m1)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients$count)),
data.frame(cleardata(mm$coefficients$zero)),
data.frame(cbind("Obs.",sum( mm$n))),
data.frame(cbind("log lik.", round( 
as.numeric(as.matrix(mm$loglik) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")
 
 
****************************************
Edit 2080728 finalize the results
*************************************
library(foreign)
fulldata<-read.dta("Fulldata20180728.dta")
 editeddata<-read.table("D:\\Protest Project\\Fulldata20180716.csv",sep=",",header=TRUE)
data<-editeddata[,1:4]
data$Hobbyist_p1<-editeddata$Hobbyist_p1
data$NUniveristy<-editeddata$NUniveristy
data$Totalpop<-editeddata$Totalpop
data$Ndealio_p1<-editeddata$Ndealio_p1
data$Pubadoption_p1<-editeddata$Pubadoption_p1
data$DeNOVO_p1<-editeddata$DeNOVO_p1
data$Hobbyist_p1<-editeddata$Hobbyist_p1
 data$NDealio <-editeddata$NDealio 
data$NUniveristy <-editeddata$NUniveristy 
data$publicadoption <-editeddata$publicadoption 
data$Ndenovo<-editeddata$Ndenovo

 fulldata<-merge(fulldata,data,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)

 fulldata$totalapplication<-fulldata$NDealio +fulldata$Ndenovo
 #variable selection
summary(fulldata$countysur_600d*fulldata$radicalmili_600d)
summary(fulldata$countysur_600d*fulldata$countymili_600d)
summary(fulldata$countysur_600d*fulldata$radicalcounty_4m)
 cor(fulldata$Pubadoption_p1,fulldata$countysur_600d)
 write.table(fulldata,file="Fulldata20180728.csv",sep=",",row.names=FALSE)
 
 
 fulldata<-read.table("Fulldata20180728.csv",sep=",",header=TRUE)
checkfile<-read.table("Fulldata20180727.csv",sep=",",header=TRUE)
checkfile1<-checkfile[,1:4]
checkfile1$checkapply<-checkfile$totalapplication

checkfile1$cumupublicadoption<-checkfile$cumupublicadoption

fulldata<-merge(fulldata,checkfile1,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)



 fulldata$antisurveillance<-fulldata$statesur_600d+fulldata$countysur_600d
 
 
fulldata$testapplication<-fulldata$napplication-fulldata$publicadoption-fulldata$NUniveristy

fulldata[which(fulldata$testapplication<0),]$testapplication<-0


add<-checkfile[,1:4]
add$newtotalpop<-checkfile$newtotalpop
fulldata<-merge(fulldata,add,by.x=c("statefips","year","month","countyfips"),
by.y=c("statefips","year","month","countyfips"),all.x=TRUE)


 write.table(fulldata,file="Fulldata20180729.csv",sep=",",row.names=FALSE)
 
 fulldata<-read.table("Fulldata20180729.csv",sep=",",header=TRUE)
 
 **************
 variables
 ***********
gdppercap  +
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
california+ 
as.character(newid)


 
 countymili_600d+
countymiliresidual+

radicalmili_600d+
radicalmiliresidual+

antisurveillance+
antisurveillanceresidual+

radicalcounty_4m+
radicalsurveilresidual+


countysur_600d

 #Test the fitness of models

cor(fulldata$countymili_600d,fulldata$antisurveillance)

library(pscl)


m1<-zeroinfl(testapplication~
 countymili_600d*radicalcounty_4m+
countymiliresidual+

gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 
 
 
summary(m1)
 
 
m2<-glm(testapplication~
 countymili_600d+
countymiliresidual+
gdppercap  +
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
california+  
as.character(newid),family="poisson",data=fulldata)


 vuong(m1, m2, digits = getOption("digits"))

 Sys.getenv("R_LIBS_USER")
[1] "C:\\Users\\wang547\\Documents/R/win-library/3.4"


install.packages("MASS")
install.packages("lattice")
install.packages("msme")
library(msme)
library(MASS)
library(lattice)
P__disp(m2)
  
library(pscl)




results1<-lm(countymili_600d~tempfirstmin +tempsecondmin+as.character(statefips) ,data=fulldata)




fulldata$countymiliresidual<-results1$residuals




results2<-lm(radicalmili_600d~tempfirstmin +tempsecondmin+as.character(statefips) ,data=fulldata)


fulldata$radicalmiliresidual<-results2$residuals


results3<-lm(antisurveillance~tempfirstmin +tempsecondmin+as.character(statefips) ,data=fulldata)

fulldata$antisurveillanceresidual<-results3$residuals



results4<-lm(radicalcounty_4m~tempfirstmin +tempsecondmin+as.character(statefips) ,data=fulldata)

fulldata$radicalsurveilresidual<-results4$residuals



*********************************************
write OLS table
***********************************************
mm<-summary(results1)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients)),
data.frame(cbind("Obs.",nrow(fulldata))),
data.frame(cbind("Adjust R Square", round( 
as.numeric(as.matrix(mm$adj.r.squared) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

*********************************************
Test the inequality impact of four types of protests
************************************************

library(pscl)


m1<-zeroinfl(testapplication~
 countymili_600d+
radicalmili_600d+
antisurveillance+
radicalcounty_4m+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 


library(nlWaldTest)
library(matrixStats)
mm<- m1$vcov[1:length(m1$coefficients$count),1:length(m1$coefficients$count)]


nlWaldtest(texts="b[2]-b[3]=0.1", coeff=m1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[2]-b[4]=0.1", coeff=m1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[2]-b[5]=0.1", coeff=m1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[3]-b[4]=0.1", coeff=m1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[3]-b[5]=0.1", coeff=m1$coefficients$count, Vcov=mm)
nlWaldtest(texts="b[4]-b[5]=0.1", coeff=m1$coefficients$count, Vcov=mm)


*********************************************
Average Treatment Effect
************************************************
countymili<-read.table("countymili.csv",sep=",",header=TRUE)

countymili<-read.table("countysur.csv",sep=",",header=TRUE)


countymili<-read.table("radicalmili.csv",sep=",",header=TRUE)


countymili<-read.table("radicalcountysur.csv",sep=",",header=TRUE)

countymili<-unique(countymili)
countymili$countymili<-1

fulldata<-fulldata[,1:99]
fulldata<-merge(fulldata,countymili,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month","countyfips"),all.x=TRUE)

fulldata[which(is.na(fulldata$countymili)),]$countymili<-0

countymili$date<-as.Date(paste(countymili$year,countymili$month,"01",sep="-"))
fulldata$date<-as.Date(paste(fulldata$year,fulldata$month,"01",sep="-"))

results<-glm(countymili~tempfirstmin+
tempsecondmin+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply
,data=fulldata,family = binomial)

fulldata$probabilitymili<-results$fitted.values

mm<-matrix(0,nrow=nrow(countymili),ncol=4)

for(i in 1:nrow(countymili)){

address1<-which(
as.Date(fulldata[,101])<as.Date(countymili[i,6]) & 
as.Date(fulldata[,101])>(as.Date(countymili[i,6])-120) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))==as.numeric(as.matrix(countymili[i,2])))


address2<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])-120) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))!=as.numeric(as.matrix(countymili[i,2])))


address3<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]+120) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))==as.numeric(as.matrix(countymili[i,2])))


address4<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]+120) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))!=as.numeric(as.matrix(countymili[i,2])))



if(length(address1)!=0 &length(address2)!=0 &length(address3)!=0 &length(address4)!=0  ){
mm[i,1]<-sum(fulldata[address1,]$testapplication)
mm[i,2]<-sum(fulldata[address2,]$testapplication%*%fulldata[address2,]$probabilitymili)
mm[i,3]<-sum(fulldata[address3,]$testapplication)

mm[i,4]<-sum(fulldata[address4,]$testapplication%*%fulldata[address4,]$probabilitymili)
}

}
output<-mm[which(mm[,3]<mm[,1]|mm[,3]==mm[,1]),]
rbind(colMeans(output),colVars(output))

write.table(rbind(colMeans(output),colVars(output)),file="test.csv",sep=",",row.names=FALSE)


*********************************************
Interaction Models
************************************************

library(pscl)
antisurveillance*radicalmili_600d+
antisurveillanceresidual+


m1<-zeroinfl(testapplication~
antisurveillance*radicalcounty_4m+
antisurveillanceresidual+

gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE) 
 
 
summary(m1)

*********************************************
Diversity prediction
************************************************
install.packages("sampleSelection")
library(sampleSelection)

fulldata$diversity_2m<-1-fulldata$diversity_2m
fulldata$diversitydummy<-0
fulldata[which(!is.na(fulldata$diversity_2m)),]$diversitydummy<-1

m1<- selection( diversitydummy ~ 
tempfirstmin +tempsecondmin,

testapplication~
diversity_2m+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month),
data = fulldata, method = "2step" )

mm<-summary(m1)

print.xtable(xtable(
rbind(data.frame(cleardata(mm$estimate)),
data.frame(cbind("Obs.",nrow(fulldata))),
data.frame(cbind("R square", round( 
as.numeric(as.matrix(mm$rSquared) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")



write.table(fulldata,file="Fulldata_20180729.csv",sep=",",row.names=FALSE)


*********************************************
write tables
***********************************************
mm<-summary(m1)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients$count)),
data.frame(cleardata(mm$coefficients$zero)),
data.frame(cbind("Obs.",sum( mm$n))),
data.frame(cbind("log lik.", round( 
as.numeric(as.matrix(mm$loglik) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")


******************************************
20180730 Add Final Figures
*********************************************
fulldata<-read.table("Fulldata_20180729.csv",sep=",",header=TRUE)

addup<-function(input){
return(sum(input[,5]))
}
library(plyr)
results<-ddply(fulldata,.(year, month),addup)

#draw interaction


library(pscl)
antisurveillance*radicalmili_600d+
antisurveillanceresidual+


m1<-zeroinfl(testapplication~
antisurveillance*radicalcounty_4m+
antisurveillanceresidual+

gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE,x=TRUE) 
 
 
summary(m1)


**************************************
Draw Interaction Effect
*********************************************
results1<-m1

coefficients<- results1$coefficients$count
meanofvariable<-colMeans(results1$x$count)

mm<-matrix(0,nrow=2, ncol=8)
for(i in 1:2){
for(j in 1:8){
meanofvariable[2]<-i-1
meanofvariable[3]<-j-1
meanofvariable[length(meanofvariable)]<-(i-1)*(j-1)
mm[i,j]<-exp(t(coefficients)%*%meanofvariable)
}}

write.table(mm,file="graph1.csv",sep=",",row.names=FALSE)

****************************



************************

Amended code 20180801
************************


#Test the strength of instrumental variable
fulldata<-read.table("Fulldata_20180729.csv",sep=",",header=TRUE)


#instrumental variable


 library(rsq)
 results1<-lm(countymili_600d~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(countymili_600d~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(countymili_600d~tempfirstmin,data=fulldata)

results3<-lm(countymili_600d~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

fulldata$countymiliresidual<-(results2$residual-mean(results2$residual))/sd(results2$residual)
fulldata$countymili_600d_test<-(fulldata$countymili_600d-mean(fulldata$countymili_600d
))/sd(fulldata$countymili_600d)

cor(fulldata$countymiliresidual, fulldata$countymili_600d)

 results1<-lm(radicalmili_600d~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(radicalmili_600d~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(radicalmili_600d~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(radicalmili_600d~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)
fulldata$radicalmiliresidual<-(results3$residual-mean(results3$residual))/sd(results3$residual)
fulldata$radicalmili_600d_test<-(fulldata$radicalmili_600d-mean(fulldata$radicalmili_600d))/sd(fulldata$radicalmili_600d)

cor(fulldata$radicalmili_600d_test, fulldata$radicalmiliresidual)



 results1<-lm(antisurveillance~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(antisurveillance~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(antisurveillance~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(antisurveillance~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)

fulldata$antisurveillanceresidual<-(results1$residual-mean(results1$residual))/sd(results1$residual)

fulldata$antisurveillance_test<-(fulldata$antisurveillance-
mean(fulldata$antisurveillance))/sd(fulldata$antisurveillance)

cor(fulldata$radicalcounty_4m_test, fulldata$antisurveillance)

 results1<-lm(radicalcounty_4m~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(radicalcounty_4m~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(radicalcounty_4m~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(radicalcounty_4m~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)

fulldata$radicalsurveilresidual<-(results2$residual-mean(results2$residual))/sd(results2$residual)

fulldata$radicalcounty_4m_test<-(fulldata$radicalcounty_4m-mean(fulldata$radicalcounty_4m))/sd(fulldata$radicalcounty_4m)


install.packages("rsq")

library(pscl)
countymili_600d_test*radicalmili_600d_test+
countymiliresidual+

 radicalcounty_4m+
antisurveillance_test*radicalcounty_4m+
antisurveillanceresidual+


m1<-zeroinfl(testapplication~
countymili_600d_test*radicalmili_600d_test+
countymiliresidual+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)+
as.character(statefips)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE,x=TRUE) 
 
 
summary(m1)

#redraw the interaction
results1<-m1
coefficients<- results1$coefficients$count
meanofvariable<-colMeans(results1$x$count)

mm<-matrix(0,nrow=2, ncol=8)
for(i in 1:2){
for(j in 1:8){
meanofvariable[2]<-i-1
meanofvariable[3]<-j-1
meanofvariable[length(meanofvariable)]<-(i-1)*(j-1)
mm[i,j]<-exp(t(coefficients)%*%meanofvariable)
}}

write.table(mm,file="graph1.csv",sep=",",row.names=FALSE)

*******************************************
calculate diversity
******************************************

diveristycal<-function(input){
n<-length(input)
if(sum(input[5:n])!=0){
output<- -sum((input[5:n]/sum(input[5:n]))*log(input[5:n]/sum(input[5:n])+1))
}else{
output<-NA
}
return(output)
}
diversity<-fulldata[,1:4]


diversity$countysur_600d<-fulldata$countysur_600d

diversity$radicalmili_600d<-fulldata$radicalmili_600d
diversity$radicalcounty_4m<-fulldata$radicalcounty_4m

diversity$countymili_600d<-fulldata$countymili_600d


results<-apply(diversity,1,diveristycal)

fulldata$diversity_test<-results


library(sampleSelection)

fulldata$diversitydummy<-0
fulldata[which(!is.na(fulldata$diversity_test)),]$diversitydummy<-1

m1<- selection( diversitydummy ~ 
tempfirstmin +tempsecondmin+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply,

testapplication~
diversity_test+

gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)+statefips,
data = fulldata, method = "2step" )

mm<-summary(m1)




print.xtable(xtable(
rbind(data.frame(cleardata(mm$estimate)),
data.frame(cbind("Obs.",nrow(fulldata))),
data.frame(cbind("R square", round( 
as.numeric(as.matrix(mm$rSquared) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

#######################################################
 
 radicalcounty_4m_test+
antisurveillance_test*radicalcounty_4m_test+



 countymili_600d+
countymiliresidual+

radicalmili_600d+
radicalmiliresidual+
radicalmili_600d_test+
radicalmiliresidual+

antisurveillance+
antisurveillanceresidual+

radicalcounty_4m+
radicalsurveilresidual+
radicalcounty_4m_test+
radicalsurveilresidual+

library(foreign)
library(pscl)
require(ffbase)
require(LaF)
require(ETLUtils)
library(xtable)
require(biglm)
library(psych)

library(xtable)


cleardata<-function(input){
names<-rownames(input)
final<-matrix("",nrow=nrow(input)*2,ncol=2)
j=1
for(i in 1:nrow(input)){
st<-paste("(",round(as.numeric(as.matrix(input[i,2])),digits=5),")",sep="")
if(!is.na(input[i,4])){
if(as.numeric(input[i,4])<=0.001){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"***",sep="")
}
if(as.numeric(input[i,4]<=0.01&as.numeric(input[i,4])>0.001 )){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"**",sep="")
}
if(as.numeric(input[i,4]<=0.05&&as.numeric(input[i,4])>0.01)){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"*",sep="")
}
if(as.numeric(input[i,4]<=0.1&&as.numeric(input[i,4])>0.05)){
coe<-paste(round(as.numeric(input[i,1]),digits=5),"+",sep="")
}
if(as.numeric(input[i,4])>0.1){
coe<-round(as.numeric(input[i,1]),digits=5)}
}else{
coe<-"NA"
}
final[j,1]<-names[i]
final[j,2]<-coe
final[j+1,2]<-st
j<-j+2
}
return(final)
}


# write zero inflation model
mm<-summary(m1)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients$count)),
data.frame(cleardata(mm$coefficients$zero)),
data.frame(cbind("Obs.",sum( mm$n))),
data.frame(cbind("log lik.", round( 
as.numeric(as.matrix(mm$loglik) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

#write summary Table
#construct subdata set for summary
data<-fulldata[,1:4]


data$radicalcounty_4m<-fulldata$radicalcounty_4m
data$antisurveillance<-fulldata$antisurveillance
data$radicalmili_600d<-fulldata$radicalmili_600d
data$countymili_600d<-fulldata$countymili_600d
data$diversity_test<-fulldata$diversity_test
data$tempfirstmin<-fulldata$tempfirstmin
data$rainfall<-fulldata$rainfall
data$gdppercap<-fulldata$gdppercap

data$newtotalpop<-fulldata$newtotalpop
data$dronemanufacture<-fulldata$dronemanufacture
data$logpilots<-fulldata$logpilots
data$citysecurity<-fulldata$citysecurity
data$cityprivacy<-fulldata$cityprivacy
data$accidents_4m<-fulldata$accidents_4m
data$cumuapply<-fulldata$cumuapply

matrixfinal<-cor(data)

matrixfinal[upper.tri(matrixfinal,diag=TRUE)]<-""

print.xtable(xtable(matrixfinal),type="html",file="Correlation.html")

print.xtable(xtable(data.frame(describe(
data))),type="html",file="Countysummary.html")







1. List variables and sources
2. Under the FAA Part 107, anyone wanting to operate the drone commercially needs to obtain a remote pilot certification with a small UAS rating. It is easier for people with pilot liscense to obtain the remote pilot certification with free online courses. 
We assume these pilots are more likely to get the remote pilot liscense
3. Test the instrumental variables
R square test
F test


The R-squared you refer to is usually a partial R-squared, i.e. the "squared partial correlation" between the excluded instruments and the endogenous regressor. The relevant reference for this test would be

Shea, J., 1997, "Instrument Relevance in Multivariate Linear Models: A Simple Measure", Review of Economics and Statistics, Vol. 79, No. 2, May, 348-352

From there you will also see how to get the critical values for the test. Some statistical software like Stata produce these values automatically like the command ivreg2, for instance.

The F-test you refer to also is related to the first stage, i.e. the regression of your endogenous variable on the instrument(s) and the exogenous variables. In case of one instrument, the F-statistic is the t-statistic squared. As a rule of thumb you should be worried about weak instruments if your F-statistic is below 10. The reference is

Stock J, Yogo M. Testing for Weak Instruments in Linear IV Regression. In Andrews DWK Identification and Inference for Econometric Models New York: Cambridge University Press; 2005. pp. 80


************************

Amended code 20180801
************************


#Test the strength of instrumental variable
fulldata<-read.table("Fulldata_20180729.csv",sep=",",header=TRUE)


#instrumental variable


 library(rsq)
 results1<-lm(countymili_600d~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(countymili_600d~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(countymili_600d~tempfirstmin,data=fulldata)

results3<-lm(countymili_600d~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

fulldata$countymiliresidual<-(results2$residual-mean(results2$residual))/sd(results2$residual)
fulldata$countymili_600d_test<-(fulldata$countymili_600d-mean(fulldata$countymili_600d
))/sd(fulldata$countymili_600d)

cor(fulldata$countymiliresidual, fulldata$countymili_600d)

 results1<-lm(radicalmili_600d~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(radicalmili_600d~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(radicalmili_600d~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(radicalmili_600d~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)
fulldata$radicalmiliresidual<-(results3$residual-mean(results3$residual))/sd(results3$residual)
fulldata$radicalmili_600d_test<-(fulldata$radicalmili_600d-mean(fulldata$radicalmili_600d))/sd(fulldata$radicalmili_600d)

cor(fulldata$radicalmili_600d_test, fulldata$radicalmiliresidual)



 results1<-lm(antisurveillance~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(antisurveillance~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(antisurveillance~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(antisurveillance~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)

fulldata$antisurveillanceresidual<-(results1$residual-mean(results1$residual))/sd(results1$residual)

fulldata$antisurveillance_test<-(fulldata$antisurveillance-
mean(fulldata$antisurveillance))/sd(fulldata$antisurveillance)

cor(fulldata$radicalcounty_4m_test, fulldata$antisurveillance)

 results1<-lm(radicalcounty_4m~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(radicalcounty_4m~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(radicalcounty_4m~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(radicalcounty_4m~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)

fulldata$radicalsurveilresidual<-(results2$residual-mean(results2$residual))/sd(results2$residual)

fulldata$radicalcounty_4m_test<-(fulldata$radicalcounty_4m-mean(fulldata$radicalcounty_4m))/sd(fulldata$radicalcounty_4m)


install.packages("rsq")

library(pscl)
countymili_600d_test*radicalmili_600d_test+
countymiliresidual+

 radicalcounty_4m+
antisurveillance_test*radicalcounty_4m+
antisurveillanceresidual+
countymili_600d_test*radicalmili_600d_test+
countymiliresidual+

m1<-zeroinfl(testapplication~
 radicalcounty_4m+
 radicalmiliresidual+
 radicalmili_600d_test+
countymili_600d_test+
countymiliresidual+

radicalsurveilresidual+
antisurveillance_test+
antisurveillanceresidual+

gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)+
as.character(statefips)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE,x=TRUE) 
 
 
summary(m1)

#redraw the interaction
results1<-m1
coefficients<- results1$coefficients$count
meanofvariable<-colMeans(results1$x$count)

mm<-matrix(0,nrow=2, ncol=8)
for(i in 1:2){
for(j in 1:8){
meanofvariable[2]<-i-1
meanofvariable[3]<-j-1
meanofvariable[length(meanofvariable)]<-(i-1)*(j-1)
mm[i,j]<-exp(t(coefficients)%*%meanofvariable)
}}

write.table(mm,file="graph1.csv",sep=",",row.names=FALSE)

*******************************************
calculate diversity
******************************************

diveristycal<-function(input){
n<-length(input)
if(sum(input[5:n])!=0){
output<- -sum((input[5:n]/sum(input[5:n]))*log(input[5:n]/sum(input[5:n])+1))
}else{
output<-NA
}
return(output)
}
diversity<-fulldata[,1:4]


diversity$countysur_600d<-fulldata$countysur_600d

diversity$radicalmili_600d<-fulldata$radicalmili_600d
diversity$radicalcounty_4m<-fulldata$radicalcounty_4m

diversity$countymili_600d<-fulldata$countymili_600d


results<-apply(diversity,1,diveristycal)

fulldata$diversity_test<-results


library(sampleSelection)

fulldata$diversitydummy<-0
fulldata[which(!is.na(fulldata$diversity_test)),]$diversitydummy<-1

m1<- selection( diversitydummy ~ 
tempfirstmin +tempsecondmin+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply,

testapplication~
diversity_test+

gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(year)+
as.character(month)+statefips,
data = fulldata, method = "2step" )

mm<-summary(m1)




print.xtable(xtable(
rbind(data.frame(cleardata(mm$estimate)),
data.frame(cbind("Obs.",nrow(fulldata))),
data.frame(cbind("R square", round( 
as.numeric(as.matrix(mm$rSquared) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

#######################################################
 
 radicalcounty_4m_test+
antisurveillance_test*radicalcounty_4m_test+



 countymili_600d+
countymiliresidual+

radicalmili_600d+
radicalmiliresidual+
radicalmili_600d_test+
radicalmiliresidual+

antisurveillance+
antisurveillanceresidual+

radicalcounty_4m+
radicalsurveilresidual+
radicalcounty_4m_test+
radicalsurveilresidual+

library(foreign)
library(pscl)
require(ffbase)
require(LaF)
require(ETLUtils)
library(xtable)
require(biglm)
library(psych)

library(xtable)


cleardata<-function(input){
names<-rownames(input)
final<-matrix("",nrow=nrow(input)*2,ncol=2)
j=1
for(i in 1:nrow(input)){
st<-paste("(",round(as.numeric(as.matrix(input[i,2])),digits=3),")",sep="")
if(!is.na(input[i,4])){
if(as.numeric(input[i,4])<=0.001){
coe<-paste(round(as.numeric(input[i,1]),digits=3),"***",sep="")
}
if(as.numeric(input[i,4]<=0.01&as.numeric(input[i,4])>0.001 )){
coe<-paste(round(as.numeric(input[i,1]),digits=3),"**",sep="")
}
if(as.numeric(input[i,4]<=0.05&&as.numeric(input[i,4])>0.01)){
coe<-paste(round(as.numeric(input[i,1]),digits=3),"*",sep="")
}
if(as.numeric(input[i,4]<=0.1&&as.numeric(input[i,4])>0.05)){
coe<-paste(round(as.numeric(input[i,1]),digits=3),"+",sep="")
}
if(as.numeric(input[i,4])>0.1){
coe<-round(as.numeric(input[i,1]),digits=3)}
}else{
coe<-"NA"
}
final[j,1]<-names[i]
final[j,2]<-coe
final[j+1,2]<-st
j<-j+2
}
return(final)
}


# write zero inflation model
mm<-summary(m1)
print.xtable(xtable(
rbind(data.frame(cleardata(mm$coefficients$count)),
data.frame(cleardata(mm$coefficients$zero)),
data.frame(cbind("Obs.",sum( mm$n))),
data.frame(cbind("log lik.", round( 
as.numeric(as.matrix(mm$loglik) ),digits=2) ))
)
)
,type="html",file="numfundingzipsubset1.html")

#write summary Table
#construct subdata set for summary
data<-fulldata[,1:4]

data$testapplication<-fulldata$testapplication
data$radicalcounty_4m<-fulldata$radicalcounty_4m
data$antisurveillance<-fulldata$antisurveillance
data$radicalmili_600d<-fulldata$radicalmili_600d
data$countymili_600d<-fulldata$countymili_600d
data$diversity_test<-fulldata$diversity_test
data$tempfirstmin<-fulldata$tempfirstmin
data$rainfall<-fulldata$rainfall
data$gdppercap<-fulldata$gdppercap

data$newtotalpop<-fulldata$newtotalpop
data$dronemanufacture<-fulldata$dronemanufacture
data$logpilots<-fulldata$logpilots
data$citysecurity<-fulldata$citysecurity
data$cityprivacy<-fulldata$cityprivacy
data$accidents_4m<-fulldata$accidents_4m
data$cumuapply<-fulldata$cumuapply

matrixfinal<-cor(data)

matrixfinal[upper.tri(matrixfinal,diag=TRUE)]<-""

print.xtable(xtable(matrixfinal),type="html",file="Correlation.html")

print.xtable(xtable(data.frame(describe(
data))),type="html",file="Countysummary.html")





The R-squared you refer to is usually a partial R-squared, i.e. the "squared partial correlation" between the excluded instruments and the endogenous regressor. The relevant reference for this test would be

Shea, J., 1997, "Instrument Relevance in Multivariate Linear Models: A Simple Measure", Review of Economics and Statistics, Vol. 79, No. 2, May, 348-352

From there you will also see how to get the critical values for the test. Some statistical software like Stata produce these values automatically like the command ivreg2, for instance.

The F-test you refer to also is related to the first stage, i.e. the regression of your endogenous variable on the instrument(s) and the exogenous variables. In case of one instrument, the F-statistic is the t-statistic squared. As a rule of thumb you should be worried about weak instruments if your F-statistic is below 10. The reference is

Stock J, Yogo M. Testing for Weak Instruments in Linear IV Regression. In Andrews DWK Identification and Inference for Econometric Models New York: Cambridge University Press; 2005. pp. 80



library(nlWaldTest)
library(matrixStats)
mm<- m1$vcov[1:length(m1$coefficients$count),1:length(m1$coefficients$count)]

mm<-matrix(0,nrow=2,ncol=2)
mm[1,1]<-1.005
mm[2,2]<-0.104
coeff<-c(-5.4,-0.3)
nlWaldtest(texts="b[1]-b[2]=0.1", coeff=coeff, Vcov=mm)

fulldata<-read.table("Fulldata_20180801.csv",sep=",",header=TRUE)

mm<-matrix(0,nrow=2,ncol=2)
mm[1,1]<-2.1
mm[2,2]<-0.05
coeff<-c(-4.5,-0.1)
nlWaldtest(texts="b[1]-b[2]=0.1", coeff=coeff, Vcov=mm)



*****************************
combine two protests together

******************************

fulldata<-read.table("Fulldata_20180801.csv",sep=",",header=TRUE)

fulldata$combinemoderateprotest<-fulldata$countymili_600d+fulldata$antisurveillance
fulldata$combineradicalprotest<-fulldata$radicalcounty_4m+fulldata$radicalmili_600d

 results1<-lm(combineradicalprotest~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(combineradicalprotest~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(combineradicalprotest~tempfirstmin,data=fulldata)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(combineradicalprotest~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)



fulldata$radicalresidual<-(results2$residual-mean(results2$residual))/sd(results2$residual)

fulldata$radical_test<-(fulldata$combineradicalprotest-mean(fulldata$combineradicalprotest))/sd(fulldata$combineradicalprotest)


 results1<-lm(combinemoderateprotest~tempfirstmin +tempsecondmin+rainfall,data=fulldata)
results2<-lm(combinemoderateprotest~tempfirstmin +tempsecondmin,data=fulldata)
results3<-lm(combinemoderateprotest~tempfirstmin,data=fulldata)
library(rsq)
rsq.partial(results1,results2)
rsq.partial(results3,results2)

results3<-lm(combinemoderateprotest~tempfirstmin+as.character(statefips)+as.character(newid),data=fulldata)



fulldata$moderateresidual<-(results1$residual-mean(results1$residual))/sd(results1$residual)

fulldata$moderate_test<-(fulldata$combinemoderateprotest-mean(fulldata$combinemoderateprotest))/sd(fulldata$combinemoderateprotest)


library(pscl)

radical_test+
radicalresidual+

m1<-zeroinfl(testapplication~
moderate_test*combineradicalprotest+
moderateresidual+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply+
as.character(month)+
as.character(statefips)
|
dronemanufacture+
logpilots+
statesecurity+
 stateprivacy+ 
california+  
gdppercap +
newtotalpop 
 , data=fulldata, dist = "poisson", EM = TRUE,x=TRUE) 
 
 
summary(m1)

****************************
Summary Table
*****************************

data<-fulldata[,1:4]

data$testapplication<-fulldata$testapplication
data$combinemoderateprotest<-fulldata$combinemoderateprotest
data$combineradicalprotest<-fulldata$combineradicalprotest
data$radicalmili_600d<-fulldata$radicalmili_600d
data$countymili_600d<-fulldata$countymili_600d
data$diversity_test<-fulldata$diversity_test
data$tempfirstmin<-fulldata$tempfirstmin
data$rainfall<-fulldata$rainfall
data$gdppercap<-fulldata$gdppercap

data$newtotalpop<-fulldata$newtotalpop
data$dronemanufacture<-fulldata$dronemanufacture
data$logpilots<-fulldata$logpilots
data$citysecurity<-fulldata$citysecurity
data$cityprivacy<-fulldata$cityprivacy
data$accidents_4m<-fulldata$accidents_4m
data$cumuapply<-fulldata$cumuapply

matrixfinal<-cor(data)

matrixfinal[upper.tri(matrixfinal,diag=TRUE)]<-""

print.xtable(xtable(matrixfinal),type="html",file="Correlation.html")

print.xtable(xtable(data.frame(describe(
data))),type="html",file="Countysummary.html")


********************
average treatment effect

**********************

countymili<-read.table("Moderate.csv",sep=",",header=TRUE)

countymili<-read.table("Radical.csv",sep=",",header=TRUE)


library(matrixStats)

countymili<-unique(countymili)
countymili$countymili<-1

fulldata<-fulldata[,1:99]
fulldata<-merge(fulldata,countymili,by.x=c("statefips", "year", "month", "countyfips"),
by.y=c("statefips", "year", "month","countyfips"),all.x=TRUE)

fulldata[which(is.na(fulldata$countymili)),]$countymili<-0

countymili$date<-as.Date(paste(countymili$year,countymili$month,"01",sep="-"))
fulldata$date<-as.Date(paste(fulldata$year,fulldata$month,"01",sep="-"))

results<-glm(countymili~tempfirstmin+
tempsecondmin+
gdppercap+
newtotalpop+
dronemanufacture+
logpilots+
citysecurity+
 cityprivacy+
accidents_4m+
cumuapply
,data=fulldata,family = binomial)

fulldata$probabilitymili<-results$fitted.values

mm<-matrix(0,nrow=nrow(countymili),ncol=4)

for(i in 1:nrow(countymili)){

address1<-which(
as.Date(fulldata[,101])<as.Date(countymili[i,6]) & 
as.Date(fulldata[,101])>(as.Date(countymili[i,6])-120) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))==as.numeric(as.matrix(countymili[i,2])))


address2<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])-120) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))!=as.numeric(as.matrix(countymili[i,2])))


address3<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]+120) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))==as.numeric(as.matrix(countymili[i,2])))


address4<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]+120) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))!=as.numeric(as.matrix(countymili[i,2])))



if(length(address1)!=0 &length(address2)!=0 &length(address3)!=0 &length(address4)!=0  ){
mm[i,1]<-sum(fulldata[address1,]$testapplication)
mm[i,2]<-sum(fulldata[address2,]$testapplication%*%fulldata[address2,]$probabilitymili)
mm[i,3]<-sum(fulldata[address3,]$testapplication)

mm[i,4]<-sum(fulldata[address4,]$testapplication%*%fulldata[address4,]$probabilitymili)
}

}
output<-mm[which(mm[,3]<mm[,1]|mm[,3]==mm[,1]),]
rbind(colMeans(output),colVars(output))

write.table(rbind(colMeans(output),colVars(output)),file="test.csv",sep=",",row.names=FALSE)

*****************************
Randomize to test p value

******************************

statecounty<-fulldata[,1:2]
statecounty$countyfips<-fulldata$countyfips
statecounty$year<-NULL
statecounty<-unique(statecounty)

runsimulation<-function(countymili,n,statecounty,fulldata){

k<-matrix(0,nrow=1, ncol=n)

for(i in 1:n){

address<-sample(1:nrow(statecounty),nrow(countymili))
countymili$statefips<-statecounty[address,]$statefips
countymili$countyfips<-statecounty[address,]$countyfips

#random sampling and calculate the treatment effect
mm<-matrix(0,nrow=nrow(countymili),ncol=2)

for(i in 1:nrow(countymili)){

address1<-which(
as.Date(fulldata[,101])<as.Date(countymili[i,6]) & 
as.Date(fulldata[,101])>(as.Date(countymili[i,6])-120) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))==as.numeric(as.matrix(countymili[i,2])))



address3<-which(
as.Date(fulldata$date)<as.Date(countymili[i,6]+120) & 
as.Date(fulldata$date)>(as.Date(countymili[i,6])) 
&as.numeric(as.matrix(fulldata[,1]))==as.numeric(as.matrix(countymili[i,1]))
&as.numeric(as.matrix(fulldata[,4]))==as.numeric(as.matrix(countymili[i,2])))



if(length(address1)!=0 &length(address3)!=0 ){
mm[i,1]<-sum(fulldata[address1,]$testapplication)

mm[i,2]<-sum(fulldata[address3,]$testapplication)


}

}

output<-mm[,2]-mm[,1]
k[i]<-mean(output)

}
k<-k[which(!is.na(k))]
mean<-mean(k,na.rm=TRUE)
var<-mean(var(k,na.rm=TRUE),na.rm=TRUE)

output<-data.frame(mean)
output<-cbind(output,var)
return(output)
}
time<-proc.time()
results<-runsimulation(countymili, 1000,statecounty,fulldata)
proc.time()-time
results<-c(-5e-05, 2.5e-06)

z <- (-0.33-results[1])/(sqrt(results[2])/sqrt(nrow(fulldata)))
2*pnorm(-abs(z))
